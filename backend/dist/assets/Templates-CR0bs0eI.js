import{_ as ee,g as i,c as R,o as x,d as a,t as h,F as oe,C as se,e,w as t,h as p,N as Z,r as k,L as U,l as q,O as ve,q as K,a as ue,K as le,G as be,a6 as fe,a7 as ye,s as pe,E as z,W as ge,P as we,J as _e,n as xe,v as he,B as Ve,a8 as Se,T as ke,U as De}from"./index-Cq749T7a.js";import{t as J}from"./index-DZNyvenB.js";const Te={class:"variable-category"},$e={class:"category-header"},Ce={class:"category-description"},Ee={class:"variable-list"},Me={class:"variable-info"},je={class:"variable-name"},Ae={class:"variable-description"},Ne={class:"variable-example"},Ie={class:"example-value"},ze={__name:"VariableCategory",props:{title:{type:String,required:!0},description:{type:String,required:!0},variables:{type:Array,required:!0}},emits:["insert"],setup(b,{emit:j}){const u=j,D=y=>{u("insert",y)},g=y=>`{{${y}}}`;return(y,f)=>{const _=i("el-button");return x(),R("div",Te,[a("div",$e,[a("h3",null,h(b.title),1),a("p",Ce,h(b.description),1)]),a("div",Ee,[(x(!0),R(oe,null,se(b.variables,T=>(x(),R("div",{key:T.name,class:"variable-item"},[a("div",Me,[a("div",je,[a("code",null,h(g(T.name)),1),e(_,{size:"small",type:"primary",link:"",onClick:A=>D(T.name)},{default:t(()=>f[0]||(f[0]=[p(" 插入 ")])),_:2,__:[0]},1032,["onClick"])]),a("div",Ae,h(T.description),1),a("div",Ne,[f[1]||(f[1]=a("span",{class:"example-label"},"示例值：",-1)),a("span",Ie,h(T.example),1)])])]))),128))])])}}},X=ee(ze,[["__scopeId","data-v-af9c5fd5"]]),Re={class:"variable-help"},Ue={class:"help-header"},Pe={class:"examples-section"},Le={class:"example-items"},Fe={class:"example-header"},He={class:"example-description"},Be={class:"example-template"},qe={__name:"VariableHelp",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","insert"],setup(b,{emit:j}){const u=b,D=j,g=Z({get:()=>u.modelValue,set:S=>D("update:modelValue",S)}),y=k("email"),f=[{name:".Email.Subject",description:"邮件主题",example:"【告警】系统异常通知"},{name:".Email.Sender",description:"发件人邮箱地址",example:"monitor@example.com"},{name:".Email.Content",description:"邮件正文内容",example:"数据库连接异常，请立即处理"},{name:".Email.HTMLContent",description:"邮件HTML内容",example:"<p>数据库连接异常，请立即处理</p>"},{name:".Email.ReceivedAt",description:"邮件接收时间",example:"2024-01-15 14:30:25"},{name:".Email.Size",description:"邮件大小（字节）",example:"1024"},{name:".Email.MessageID",description:"邮件唯一标识符",example:"<123456@example.com>"}],_=[{name:".Alert.ID",description:"告警ID",example:"1001"},{name:".Alert.Subject",description:"告警主题（处理后）",example:"【告警】系统异常通知"},{name:".Alert.Status",description:"告警状态",example:"active"},{name:".Alert.Content",description:"告警内容（处理后）",example:"数据库连接异常，请立即处理"},{name:".Alert.CreatedAt",description:"告警创建时间",example:"2024-01-15 14:30:25"},{name:".Alert.ReceivedAt",description:"邮件接收时间",example:"2024-01-15 14:30:25"}],T=[{name:".Rule.ID",description:"规则ID",example:"1"},{name:".Rule.Name",description:"规则名称",example:"生产环境告警规则"},{name:".Rule.MatchType",description:"匹配类型",example:"keyword"},{name:".Rule.MatchValue",description:"匹配值",example:"错误,异常,告警"},{name:".Rule.Priority",description:"规则优先级",example:"9"},{name:".Rule.Description",description:"规则描述",example:"用于匹配生产环境的告警信息"}],A=[{name:".Mailbox.ID",description:"邮箱ID",example:"1"},{name:".Mailbox.Name",description:"邮箱名称",example:"监控邮箱"},{name:".Mailbox.Email",description:"邮箱地址",example:"monitor@example.com"},{name:".Mailbox.Host",description:"IMAP服务器地址",example:"imap.example.com"},{name:".Mailbox.Port",description:"IMAP端口",example:"993"}],O=[{name:".System.AppName",description:"应用名称",example:"统一邮件告警平台"},{name:".System.AppVersion",description:"应用版本",example:"v1.0.0"},{name:".System.ServerName",description:"服务器名称",example:"alert-server-01"},{name:".System.Environment",description:"运行环境",example:"production"}],V=[{name:".Time.Now",description:"当前时间戳",example:"1705314625"},{name:".Time.NowFormat",description:"当前时间（格式化）",example:"2024-01-15 14:30:25"},{name:".Time.Today",description:"今天日期",example:"2024-01-15"},{name:".Time.Year",description:"当前年份",example:"2024"},{name:".Time.Month",description:"当前月份",example:"01"},{name:".Time.Day",description:"当前日期",example:"15"},{name:".Time.Hour",description:"当前小时",example:"14"},{name:".Time.Minute",description:"当前分钟",example:"30"},{name:".Time.Second",description:"当前秒数",example:"25"},{name:".Time.Weekday",description:"星期几",example:"星期一"}],l=[{name:"简单邮件通知",description:"最基础的邮件告警通知格式",template:`主题：{{.Email.Subject}}
发件人：{{.Email.Sender}}
时间：{{.Email.ReceivedAt}}

內容：
{{.Email.Content}}

通知时间：{{.Time.NowFormat}}`},{name:"详细告警信息",description:"包含规则和系统信息的详细告警",template:`## 🚨 {{.System.AppName}} 告警通知

**告警信息**
- 主题：{{.Email.Subject}}
- 发件人：{{.Email.Sender}}
- 接收时间：{{.Email.ReceivedAt}}

**匹配规则**
- 规则名称：{{.Rule.Name}}
- 匹配类型：{{.Rule.MatchType}}
- 优先级：{{.Rule.Priority}}

**邮件内容**
{{.Email.Content}}

---
*系统：{{.System.AppName}} | 服务器：{{.System.ServerName}} | 通知时间：{{.Time.NowFormat}}*`},{name:"HTML邮件模版",description:"富文本格式的邮件通知模版",template:`<h2 style="color: #e74c3c;">🚨 系统告警通知</h2>

<table style="width: 100%; border-collapse: collapse;">
  <tr>
    <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;"><strong>邮件主题</strong></td>
    <td style="padding: 8px; border: 1px solid #ddd;">{{.Email.Subject}}</td>
  </tr>
  <tr>
    <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;"><strong>发件人</strong></td>
    <td style="padding: 8px; border: 1px solid #ddd;">{{.Email.Sender}}</td>
  </tr>
  <tr>
    <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;"><strong>接收时间</strong></td>
    <td style="padding: 8px; border: 1px solid #ddd;">{{.Email.ReceivedAt}}</td>
  </tr>
</table>

<div style="background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-left: 4px solid #007bff;">
  <h3>邮件内容</h3>
  <p>{{.Email.Content}}</p>
</div>

<hr>
<p style="color: #6c757d; font-size: 12px;">
  通知时间：{{.Time.NowFormat}} | 系统：{{.System.AppName}} v{{.System.AppVersion}}
</p>`}],v=S=>{D("insert",S)};return(S,m)=>{const d=i("el-alert"),$=i("el-tab-pane"),W=i("el-button"),C=i("el-input"),P=i("el-tabs"),M=i("el-dialog");return x(),U(M,{modelValue:g.value,"onUpdate:modelValue":m[1]||(m[1]=E=>g.value=E),title:"模版变量帮助",width:"70%","close-on-click-modal":!1},{default:t(()=>[a("div",Re,[a("div",Ue,[e(d,{title:"变量使用说明",type:"info","show-icon":"",closable:!1},{default:t(()=>m[2]||(m[2]=[a("p",null,[p("在模版中使用变量时，请使用双大括号包围变量名，如："),a("code",null,"{{.Email.Subject}}")],-1),a("p",null,"变量名区分大小写，请按照下面的格式准确使用",-1)])),_:1})]),e(P,{modelValue:y.value,"onUpdate:modelValue":m[0]||(m[0]=E=>y.value=E),class:"variable-tabs"},{default:t(()=>[e($,{label:"邮件变量",name:"email"},{default:t(()=>[e(X,{title:"邮件相关变量",description:"从邮件中提取的基本信息",variables:f,onInsert:v})]),_:1}),e($,{label:"告警变量",name:"alert"},{default:t(()=>[e(X,{title:"告警相关变量",description:"告警处理过程中生成的信息",variables:_,onInsert:v})]),_:1}),e($,{label:"规则变量",name:"rule"},{default:t(()=>[e(X,{title:"规则相关变量",description:"匹配的告警规则信息",variables:T,onInsert:v})]),_:1}),e($,{label:"邮箱变量",name:"mailbox"},{default:t(()=>[e(X,{title:"邮箱相关变量",description:"邮箱配置信息",variables:A,onInsert:v})]),_:1}),e($,{label:"系统变量",name:"system"},{default:t(()=>[e(X,{title:"系统相关变量",description:"系统环境信息",variables:O,onInsert:v})]),_:1}),e($,{label:"时间变量",name:"time"},{default:t(()=>[e(X,{title:"时间相关变量",description:"各种时间格式",variables:V,onInsert:v})]),_:1}),e($,{label:"常用组合",name:"examples"},{default:t(()=>[a("div",Pe,[m[4]||(m[4]=a("h3",null,"常用变量组合示例",-1)),a("div",Le,[(x(),R(oe,null,se(l,E=>a("div",{key:E.name,class:"example-item"},[a("div",Fe,[a("h4",null,h(E.name),1),e(W,{size:"small",type:"primary",onClick:G=>v(E.template)},{default:t(()=>m[3]||(m[3]=[p(" 插入模版 ")])),_:2,__:[3]},1032,["onClick"])]),a("div",He,h(E.description),1),a("div",Be,[e(C,{"model-value":E.template,type:"textarea",rows:3,readonly:""},null,8,["model-value"])])])),64))])])]),_:1})]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])}}},Oe=ee(qe,[["__scopeId","data-v-ba3e621e"]]),We={class:"variable-selector"},Ye={class:"search-bar"},Je={class:"variable-tree"},Ke={class:"tree-node"},Ge={class:"node-label"},Qe={__name:"VariableSelector",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","select"],setup(b,{emit:j}){const u=b,D=j,g=Z({get:()=>u.modelValue,set:l=>D("update:modelValue",l)}),y=k(""),f=k(),_={children:"children",label:"label"},T=[{id:"email",label:"邮件变量",children:[{id:"email-subject",label:"邮件主题",variable:".Email.Subject"},{id:"email-sender",label:"发件人",variable:".Email.Sender"},{id:"email-content",label:"邮件内容",variable:".Email.Content"},{id:"email-html-content",label:"HTML内容",variable:".Email.HTMLContent"},{id:"email-received-at",label:"接收时间",variable:".Email.ReceivedAt"},{id:"email-size",label:"邮件大小",variable:".Email.Size"},{id:"email-message-id",label:"邮件ID",variable:".Email.MessageID"}]},{id:"alert",label:"告警变量",children:[{id:"alert-id",label:"告警ID",variable:".Alert.ID"},{id:"alert-subject",label:"告警主题",variable:".Alert.Subject"},{id:"alert-status",label:"告警状态",variable:".Alert.Status"},{id:"alert-content",label:"告警内容",variable:".Alert.Content"},{id:"alert-created-at",label:"创建时间",variable:".Alert.CreatedAt"},{id:"alert-received-at",label:"接收时间",variable:".Alert.ReceivedAt"}]},{id:"rule",label:"规则变量",children:[{id:"rule-id",label:"规则ID",variable:".Rule.ID"},{id:"rule-name",label:"规则名称",variable:".Rule.Name"},{id:"rule-match-type",label:"匹配类型",variable:".Rule.MatchType"},{id:"rule-match-value",label:"匹配值",variable:".Rule.MatchValue"},{id:"rule-priority",label:"优先级",variable:".Rule.Priority"},{id:"rule-description",label:"规则描述",variable:".Rule.Description"}]},{id:"mailbox",label:"邮箱变量",children:[{id:"mailbox-id",label:"邮箱ID",variable:".Mailbox.ID"},{id:"mailbox-name",label:"邮箱名称",variable:".Mailbox.Name"},{id:"mailbox-email",label:"邮箱地址",variable:".Mailbox.Email"},{id:"mailbox-host",label:"IMAP主机",variable:".Mailbox.Host"},{id:"mailbox-port",label:"IMAP端口",variable:".Mailbox.Port"}]},{id:"system",label:"系统变量",children:[{id:"system-app-name",label:"应用名称",variable:".System.AppName"},{id:"system-app-version",label:"应用版本",variable:".System.AppVersion"},{id:"system-server-name",label:"服务器名称",variable:".System.ServerName"},{id:"system-environment",label:"运行环境",variable:".System.Environment"}]},{id:"time",label:"时间变量",children:[{id:"time-now",label:"当前时间戳",variable:".Time.Now"},{id:"time-now-format",label:"格式化时间",variable:".Time.NowFormat"},{id:"time-today",label:"今天日期",variable:".Time.Today"},{id:"time-year",label:"年份",variable:".Time.Year"},{id:"time-month",label:"月份",variable:".Time.Month"},{id:"time-day",label:"日期",variable:".Time.Day"},{id:"time-hour",label:"小时",variable:".Time.Hour"},{id:"time-minute",label:"分钟",variable:".Time.Minute"},{id:"time-second",label:"秒",variable:".Time.Second"},{id:"time-weekday",label:"星期",variable:".Time.Weekday"}]}],A=(l,v)=>l?v.label.includes(l)||v.variable&&v.variable.includes(l):!0,O=l=>{var v;(v=f.value)==null||v.filter(l)},V=l=>{D("select",l)};return(l,v)=>{const S=i("el-icon"),m=i("el-input"),d=i("el-button"),$=i("el-tree"),W=i("el-dialog");return x(),U(W,{modelValue:g.value,"onUpdate:modelValue":v[1]||(v[1]=C=>g.value=C),title:"选择变量",width:"50%","close-on-click-modal":!1},{default:t(()=>[a("div",We,[a("div",Ye,[e(m,{modelValue:y.value,"onUpdate:modelValue":v[0]||(v[0]=C=>y.value=C),placeholder:"搜索变量...",clearable:"",onInput:O},{prefix:t(()=>[e(S,null,{default:t(()=>[e(q(ve))]),_:1})]),_:1},8,["modelValue"])]),a("div",Je,[e($,{ref_key:"treeRef",ref:f,data:T,"node-key":"id",props:_,"filter-node-method":A,"expand-on-click-node":!1,"default-expand-all":""},{default:t(({data:C})=>[a("div",Ke,[a("span",Ge,h(C.label),1),C.variable?(x(),U(d,{key:0,size:"small",type:"primary",onClick:P=>V(C.variable)},{default:t(()=>v[2]||(v[2]=[p(" 选择 ")])),_:2,__:[2]},1032,["onClick"])):K("",!0)])]),_:1},512)])])]),_:1},8,["modelValue"])}}},Xe=ee(Qe,[["__scopeId","data-v-9cda259d"]]),Ze={class:"template-form"},et={class:"code-editor"},tt={class:"editor-toolbar"},at={class:"preview-section"},lt={class:"preview-header"},nt={class:"preview-content subject-preview"},ot=["innerHTML"],st={class:"used-variables"},it={key:0,class:"no-variables"},rt={class:"dialog-footer"},dt={__name:"TemplateForm",props:{modelValue:{type:Boolean,default:!1},templateData:{type:Object,default:null}},emits:["update:modelValue","success"],setup(b,{emit:j}){const u=b,D=j,g=k(!1),y=k(),f=k(!1),_=k(!1),T=k(!1),A=k(!1),O=k("content"),V=Z(()=>{var o;return!!((o=u.templateData)!=null&&o.id)}),l=ue({name:"",type:"email",subject:"",content:"",is_default:!1,description:""}),v={name:[{required:!0,message:"请输入模版名称",trigger:"blur"},{min:2,max:50,message:"模版名称长度在 2 到 50 个字符",trigger:"blur"}],type:[{required:!0,message:"请选择模版类型",trigger:"change"}],content:[{required:!0,message:"请输入模版内容",trigger:"blur"},{min:10,message:"模版内容至少需要 10 个字符",trigger:"blur"}]},S=k({subject:"",content:"",used_vars:[]});le(()=>u.modelValue,o=>{g.value=o,o&&(m(),ge(()=>{M()}))}),le(g,o=>{D("update:modelValue",o)});const m=()=>{u.templateData?Object.assign(l,{name:u.templateData.name||"",type:u.templateData.type||"email",subject:u.templateData.subject||"",content:u.templateData.content||"",is_default:u.templateData.is_default||!1,description:u.templateData.description||""}):Object.assign(l,{name:"",type:"email",subject:"",content:"",is_default:!1,description:""})},d=o=>{if(o==="email"&&!l.subject&&(l.subject="【告警】{{.System.AppName}} - {{.Email.Subject}}"),!l.content)switch(o){case"email":l.content=$();break;case"dingtalk":l.content=W();break;case"wechat":l.content=C();break;case"markdown":l.content=P();break}M()},$=()=>`<h2>🚨 系统告警通知</h2>
<p><strong>邮件主题：</strong>{{.Email.Subject}}</p>
<p><strong>发件人：</strong>{{.Email.Sender}}</p>
<p><strong>接收时间：</strong>{{.Email.ReceivedAt}}</p>
<div style="background-color: #f8f9fa; padding: 10px; margin: 10px 0;">
  <h3>邮件内容</h3>
  <div>{{.Email.Content}}</div>
</div>
<p><small>通知时间：{{.Time.NowFormat}} | 系统：{{.System.AppName}}</small></p>`,W=()=>`## 🚨 系统告警通知

**告警详情**
- **邮件主题：** {{.Email.Subject}}
- **发件人：** {{.Email.Sender}}
- **接收时间：** {{.Email.ReceivedAt}}

**邮件内容**
> {{.Email.Content}}

**系统信息**
- **通知时间：** {{.Time.NowFormat}}
- **系统：** {{.System.AppName}}`,C=()=>`【系统告警通知】

邮件主题：{{.Email.Subject}}
发件人：{{.Email.Sender}}
接收时间：{{.Email.ReceivedAt}}

邮件内容：
{{.Email.Content}}

通知时间：{{.Time.NowFormat}}
系统：{{.System.AppName}}`,P=()=>`# 🚨 系统告警通知

| 项目 | 内容 |
|------|------|
| 邮件主题 | {{.Email.Subject}} |
| 发件人 | {{.Email.Sender}} |
| 接收时间 | {{.Email.ReceivedAt}} |

## 邮件内容

\`\`\`
{{.Email.Content}}
\`\`\`

---
*通知时间：{{.Time.NowFormat}} | 系统：{{.System.AppName}}*`,M=async()=>{if(l.content){_.value=!0;try{const o=await J.preview({content:l.content,subject:l.subject});S.value=o.data}catch(o){console.error("预览失败:",o),z.error("预览失败，请检查模版语法")}finally{_.value=!1}}},E=Z(()=>{if(!S.value.content)return"内容预览...";const o=S.value.content;switch(l.type){case"email":return o;case"dingtalk":case"markdown":return o.replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/\n/g,"<br>");case"wechat":default:return o.replace(/\n/g,"<br>")}}),G=()=>{A.value=!0},r=o=>{l.content+=`{{${o}}}`,M()},n=o=>{r(o),A.value=!1},N=()=>{l.type==="email"&&(l.content=l.content.replace(/></g,`>
<`).replace(/^\s+/gm,"")),M()},Y=async()=>{try{await y.value.validate(),f.value=!0;const o={name:l.name,type:l.type,subject:l.subject,content:l.content,is_default:l.is_default,description:l.description};V.value?(await J.update(u.templateData.id,o),z.success("模版更新成功")):(await J.create(o),z.success("模版创建成功")),D("success"),g.value=!1}catch(o){console.error("提交失败:",o)}finally{f.value=!1}},Q=()=>{var o;(o=y.value)==null||o.resetFields(),S.value={subject:"",content:"",used_vars:[]}};return le([()=>l.content,()=>l.subject],()=>{if(l.content){const o=setTimeout(()=>{M()},500);return()=>clearTimeout(o)}},{deep:!0}),(o,s)=>{const I=i("el-input"),L=i("el-form-item"),F=i("el-option"),H=i("el-select"),B=i("el-button"),ie=i("el-button-group"),re=i("el-switch"),de=i("el-form"),ne=i("el-col"),te=i("el-tab-pane"),me=i("el-tag"),ce=i("el-tabs"),c=i("el-row"),ae=i("el-dialog");return x(),U(ae,{modelValue:g.value,"onUpdate:modelValue":s[11]||(s[11]=w=>g.value=w),title:V.value?"编辑模版":"添加模版",width:"90%","close-on-click-modal":!1,onClosed:Q},{footer:t(()=>[a("div",rt,[e(B,{onClick:s[8]||(s[8]=w=>g.value=!1)},{default:t(()=>s[17]||(s[17]=[p("取消")])),_:1,__:[17]}),e(B,{type:"primary",onClick:Y,loading:f.value},{default:t(()=>[p(h(V.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:t(()=>[a("div",Ze,[e(c,{gutter:20},{default:t(()=>[e(ne,{span:12},{default:t(()=>[e(de,{ref_key:"formRef",ref:y,model:l,rules:v,"label-width":"80px"},{default:t(()=>[e(L,{label:"模版名称",prop:"name"},{default:t(()=>[e(I,{modelValue:l.name,"onUpdate:modelValue":s[0]||(s[0]=w=>l.name=w),placeholder:"请输入模版名称",clearable:""},null,8,["modelValue"])]),_:1}),e(L,{label:"模版类型",prop:"type"},{default:t(()=>[e(H,{modelValue:l.type,"onUpdate:modelValue":s[1]||(s[1]=w=>l.type=w),placeholder:"请选择模版类型",style:{width:"100%"},onChange:d},{default:t(()=>[e(F,{label:"邮件模版",value:"email"}),e(F,{label:"钉钉模版",value:"dingtalk"}),e(F,{label:"企业微信",value:"wechat"}),e(F,{label:"Markdown",value:"markdown"})]),_:1},8,["modelValue"])]),_:1}),l.type==="email"?(x(),U(L,{key:0,label:"邮件主题",prop:"subject"},{default:t(()=>[e(I,{modelValue:l.subject,"onUpdate:modelValue":s[2]||(s[2]=w=>l.subject=w),placeholder:"支持变量，如：【告警】{{.System.AppName}} - {{.Email.Subject}}",clearable:""},null,8,["modelValue"])]),_:1})):K("",!0),e(L,{label:"模版内容",prop:"content"},{default:t(()=>[a("div",et,[a("div",tt,[e(ie,null,{default:t(()=>[e(B,{size:"small",onClick:G,icon:q(be)},{default:t(()=>s[12]||(s[12]=[p(" 插入变量 ")])),_:1,__:[12]},8,["icon"]),e(B,{size:"small",onClick:s[3]||(s[3]=w=>T.value=!0),icon:q(fe)},{default:t(()=>s[13]||(s[13]=[p(" 变量帮助 ")])),_:1,__:[13]},8,["icon"]),e(B,{size:"small",onClick:N,icon:q(ye)},{default:t(()=>s[14]||(s[14]=[p(" 格式化 ")])),_:1,__:[14]},8,["icon"])]),_:1})]),e(I,{modelValue:l.content,"onUpdate:modelValue":s[4]||(s[4]=w=>l.content=w),type:"textarea",rows:12,placeholder:"请输入模版内容，支持变量替换，如：{{.Email.Subject}}",style:{"font-family":"'Monaco', 'Menlo', 'Ubuntu Mono', monospace"}},null,8,["modelValue"])])]),_:1}),e(L,{label:"是否默认"},{default:t(()=>[e(re,{modelValue:l.is_default,"onUpdate:modelValue":s[5]||(s[5]=w=>l.is_default=w),"active-text":"设为默认模版","inactive-text":"普通模版"},null,8,["modelValue"])]),_:1}),e(L,{label:"描述"},{default:t(()=>[e(I,{modelValue:l.description,"onUpdate:modelValue":s[6]||(s[6]=w=>l.description=w),type:"textarea",rows:3,placeholder:"请输入模版描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ne,{span:12},{default:t(()=>[a("div",at,[a("div",lt,[s[16]||(s[16]=a("span",null,"实时预览",-1)),e(B,{size:"small",type:"primary",onClick:M,loading:_.value},{default:t(()=>s[15]||(s[15]=[p(" 刷新预览 ")])),_:1,__:[15]},8,["loading"])]),e(ce,{modelValue:O.value,"onUpdate:modelValue":s[7]||(s[7]=w=>O.value=w),class:"preview-tabs"},{default:t(()=>[l.type==="email"&&l.subject?(x(),U(te,{key:0,label:"邮件主题",name:"subject"},{default:t(()=>[a("div",nt,h(S.value.subject||"主题预览..."),1)]),_:1})):K("",!0),e(te,{label:"内容预览",name:"content"},{default:t(()=>[a("div",{class:pe(["preview-content",{"html-preview":l.type==="email","markdown-preview":l.type==="dingtalk"||l.type==="markdown","text-preview":l.type==="wechat"}]),innerHTML:E.value},null,10,ot)]),_:1}),e(te,{label:"使用变量",name:"variables"},{default:t(()=>[a("div",st,[(x(!0),R(oe,null,se(S.value.used_vars,w=>(x(),U(me,{key:w,size:"small",class:"variable-tag"},{default:t(()=>[p(h(w),1)]),_:2},1024))),128)),!S.value.used_vars||S.value.used_vars.length===0?(x(),R("div",it," 暂未使用任何变量 ")):K("",!0)])]),_:1})]),_:1},8,["modelValue"])])]),_:1})]),_:1})]),e(Oe,{modelValue:T.value,"onUpdate:modelValue":s[9]||(s[9]=w=>T.value=w),onInsert:r},null,8,["modelValue"]),e(Xe,{modelValue:A.value,"onUpdate:modelValue":s[10]||(s[10]=w=>A.value=w),onSelect:n},null,8,["modelValue"])]),_:1},8,["modelValue","title"])}}},mt=ee(dt,[["__scopeId","data-v-0786f781"]]),ct={class:"template-preview"},ut={class:"preview-header"},pt={class:"template-info"},vt={class:"template-meta"},bt={class:"meta-text"},_t={class:"preview-actions"},ft={class:"preview-content"},yt={key:0,class:"subject-section"},gt={class:"subject-preview"},wt={class:"content-section"},xt=["innerHTML"],ht={class:"template-source"},Vt={key:0,class:"subject-source"},St={class:"content-source"},kt={class:"variables-section"},Dt={key:0,class:"variable-list"},Tt={key:1,class:"no-variables"},$t={class:"sample-data"},Ct={class:"dialog-footer"},Et={__name:"TemplatePreview",props:{modelValue:{type:Boolean,default:!1},templateData:{type:Object,default:null}},emits:["update:modelValue","edit"],setup(b,{emit:j}){const u=b,D=j,g=Z({get:()=>u.modelValue,set:m=>D("update:modelValue",m)}),y=k(!1),f=k("preview"),_=k({subject:"",content:"",used_vars:[]}),T={Email:{Subject:"【告警】生产环境数据库连接异常",Sender:"monitor@example.com",Content:"生产环境数据库连接出现异常，连接超时。请立即检查数据库服务器状态。错误信息：Connection timeout after 30 seconds",HTMLContent:"<p>生产环境数据库连接出现异常，连接超时。</p><p>请立即检查数据库服务器状态。</p><p><strong>错误信息：</strong>Connection timeout after 30 seconds</p>",ReceivedAt:"2024-01-15 14:30:25",Size:1024,MessageID:"<123456789@example.com>"},Alert:{ID:1001,Subject:"【告警】生产环境数据库连接异常",Status:"active",Content:"生产环境数据库连接出现异常，连接超时。请立即检查数据库服务器状态。",CreatedAt:"2024-01-15 14:30:25",ReceivedAt:"2024-01-15 14:30:25"},Rule:{ID:1,Name:"生产环境数据库告警",MatchType:"keyword",MatchValue:"数据库,连接,异常,超时",Priority:9,Description:"用于监控生产环境数据库相关告警"},Mailbox:{ID:1,Name:"生产环境监控邮箱",Email:"monitor@example.com",Host:"imap.example.com",Port:993},System:{AppName:"统一邮件告警平台",AppVersion:"v1.0.0",ServerName:"alert-server-01",Environment:"production"},Time:{Now:Math.floor(Date.now()/1e3),NowFormat:new Date().toLocaleString("zh-CN"),Today:new Date().toLocaleDateString("zh-CN"),Year:new Date().getFullYear(),Month:String(new Date().getMonth()+1).padStart(2,"0"),Day:String(new Date().getDate()).padStart(2,"0"),Hour:String(new Date().getHours()).padStart(2,"0"),Minute:String(new Date().getMinutes()).padStart(2,"0"),Second:String(new Date().getSeconds()).padStart(2,"0"),Weekday:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][new Date().getDay()]}},A=m=>({email:"primary",dingtalk:"success",wechat:"warning",markdown:"info"})[m]||"info",O=m=>({email:"邮件模版",dingtalk:"钉钉模版",wechat:"企业微信模版",markdown:"Markdown模版"})[m]||m,V=m=>m?new Date(m).toLocaleString("zh-CN"):"-",l=Z(()=>{var d;if(!_.value.content)return"加载中...";const m=_.value.content;switch((d=u.templateData)==null?void 0:d.type){case"email":return m;case"dingtalk":case"markdown":return m.replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/^> (.*$)/gm,"<blockquote>$1</blockquote>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>");case"wechat":default:return m.replace(/\n/g,"<br>")}}),v=async()=>{var m;if((m=u.templateData)!=null&&m.content){y.value=!0;try{const d=await J.preview({content:u.templateData.content,subject:u.templateData.subject||""});_.value=d.data}catch(d){console.error("预览失败:",d),z.error("预览失败，请检查模版语法")}finally{y.value=!1}}},S=()=>{D("edit",u.templateData),g.value=!1};return le(()=>u.templateData,m=>{m&&g.value&&v()},{immediate:!0}),le(g,m=>{m&&u.templateData&&(f.value="preview",v())}),(m,d)=>{const $=i("el-tag"),W=i("el-icon"),C=i("el-button"),P=i("el-tab-pane"),M=i("el-input"),E=i("el-empty"),G=i("el-tabs"),r=i("el-dialog");return x(),U(r,{modelValue:g.value,"onUpdate:modelValue":d[2]||(d[2]=n=>g.value=n),title:"模版预览",width:"80%","close-on-click-modal":!1},{footer:t(()=>[a("div",Ct,[e(C,{onClick:d[1]||(d[1]=n=>g.value=!1)},{default:t(()=>d[11]||(d[11]=[p("关闭")])),_:1,__:[11]}),e(C,{type:"primary",onClick:S},{default:t(()=>[e(W,null,{default:t(()=>[e(q(_e))]),_:1}),d[12]||(d[12]=p(" 编辑模版 "))]),_:1,__:[12]})])]),default:t(()=>{var n,N,Y,Q;return[a("div",ct,[a("div",ut,[a("div",pt,[a("h3",null,h((n=b.templateData)==null?void 0:n.name),1),a("div",vt,[e($,{type:A((N=b.templateData)==null?void 0:N.type),size:"small"},{default:t(()=>{var o;return[p(h(O((o=b.templateData)==null?void 0:o.type)),1)]}),_:1},8,["type"]),(Y=b.templateData)!=null&&Y.is_default?(x(),U($,{key:0,type:"success",size:"small"},{default:t(()=>d[3]||(d[3]=[p("默认模版")])),_:1,__:[3]})):K("",!0),a("span",bt,"更新时间："+h(V((Q=b.templateData)==null?void 0:Q.updated_at)),1)])]),a("div",_t,[e(C,{onClick:v,loading:y.value},{default:t(()=>[e(W,null,{default:t(()=>[e(q(we))]),_:1}),d[4]||(d[4]=p(" 刷新预览 "))]),_:1,__:[4]},8,["loading"])])]),e(G,{modelValue:f.value,"onUpdate:modelValue":d[0]||(d[0]=o=>f.value=o),class:"preview-tabs"},{default:t(()=>[e(P,{label:"预览效果",name:"preview"},{default:t(()=>{var o,s,I,L,F,H;return[a("div",ft,[((o=b.templateData)==null?void 0:o.type)==="email"&&((s=b.templateData)!=null&&s.subject)?(x(),R("div",yt,[d[5]||(d[5]=a("h4",null,"邮件主题",-1)),a("div",gt,h(_.value.subject||b.templateData.subject),1)])):K("",!0),a("div",wt,[d[6]||(d[6]=a("h4",null,"内容预览",-1)),a("div",{class:pe(["content-preview",{"html-preview":((I=b.templateData)==null?void 0:I.type)==="email","markdown-preview":((L=b.templateData)==null?void 0:L.type)==="dingtalk"||((F=b.templateData)==null?void 0:F.type)==="markdown","text-preview":((H=b.templateData)==null?void 0:H.type)==="wechat"}]),innerHTML:l.value},null,10,xt)])])]}),_:1}),e(P,{label:"原始模版",name:"template"},{default:t(()=>{var o,s,I;return[a("div",ht,[((o=b.templateData)==null?void 0:o.type)==="email"&&((s=b.templateData)!=null&&s.subject)?(x(),R("div",Vt,[d[7]||(d[7]=a("h4",null,"邮件主题模版",-1)),e(M,{"model-value":b.templateData.subject,type:"textarea",rows:2,readonly:"",class:"template-textarea"},null,8,["model-value"])])):K("",!0),a("div",St,[d[8]||(d[8]=a("h4",null,"内容模版",-1)),e(M,{"model-value":((I=b.templateData)==null?void 0:I.content)||"",type:"textarea",rows:15,readonly:"",class:"template-textarea"},null,8,["model-value"])])])]}),_:1}),e(P,{label:"使用变量",name:"variables"},{default:t(()=>[a("div",kt,[d[9]||(d[9]=a("h4",null,"模版中使用的变量",-1)),_.value.used_vars&&_.value.used_vars.length>0?(x(),R("div",Dt,[(x(!0),R(oe,null,se(_.value.used_vars,o=>(x(),U($,{key:o,size:"medium",class:"variable-tag"},{default:t(()=>[p(h(o),1)]),_:2},1024))),128))])):(x(),R("div",Tt,[e(E,{description:"该模版暂未使用任何变量"})]))])]),_:1}),e(P,{label:"示例数据",name:"data"},{default:t(()=>[a("div",$t,[d[10]||(d[10]=a("h4",null,"预览使用的示例数据",-1)),e(M,{"model-value":JSON.stringify(T,null,2),type:"textarea",rows:20,readonly:"",class:"json-textarea"},null,8,["model-value"])])]),_:1})]),_:1},8,["modelValue"])])]}),_:1},8,["modelValue"])}}},Mt=ee(Et,[["__scopeId","data-v-f94d74a4"]]),jt={class:"templates-page"},At={class:"page-header"},Nt={class:"header-right"},It={class:"filter-section"},zt={class:"table-section"},Rt={class:"template-name"},Ut={class:"pagination-section"},Pt={__name:"Templates",setup(b){const j=k(!1),u=k(!1),D=k(!1),g=k([]),y=k(null),f=ue({name:"",type:"",status:""}),_=ue({page:1,size:20,total:0}),T=r=>({email:"primary",dingtalk:"success",wechat:"warning",markdown:"info"})[r]||"info",A=r=>({email:"邮件",dingtalk:"钉钉",wechat:"微信",markdown:"MD"})[r]||r,O=r=>r?new Date(r).toLocaleString("zh-CN"):"-",V=async()=>{j.value=!0;try{const r={page:_.page,size:_.size,...f};Object.keys(r).forEach(N=>{(r[N]===""||r[N]===null||r[N]===void 0)&&delete r[N]});const n=await J.list(r);g.value=n.data.list||[],_.total=n.data.total||0}catch(r){console.error("加载模版列表失败:",r),z.error("加载模版列表失败")}finally{j.value=!1}},l=()=>{_.page=1,V()},v=()=>{Object.assign(f,{name:"",type:"",status:""}),l()},S=()=>{y.value=null,u.value=!0},m=r=>{y.value={...r},u.value=!0},d=r=>{y.value=r,D.value=!0},$=async(r,n)=>{switch(r){case"setDefault":await W(n);break;case"duplicate":await C(n);break;case"toggleStatus":await P(n);break;case"delete":await M(n);break}},W=async r=>{try{await J.setDefault(r.id),z.success("设置默认模版成功"),V()}catch(n){console.error("设置默认模版失败:",n),z.error("设置默认模版失败")}},C=async r=>{try{const n={name:`${r.name} - 副本`,type:r.type,subject:r.subject,content:r.content,description:`${r.description||""} (复制自 ${r.name})`,is_default:!1,status:"active"};await J.create(n),z.success("复制模版成功"),V()}catch(n){console.error("复制模版失败:",n),z.error("复制模版失败")}},P=async r=>{try{const n=r.status==="active"?"inactive":"active";await J.update(r.id,{status:n}),z.success(`模版已${n==="active"?"启用":"停用"}`),V()}catch(n){console.error("切换状态失败:",n),z.error("切换状态失败")}},M=async r=>{try{await De.confirm(`确定要删除模版"${r.name}"吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await J.delete(r.id),z.success("删除模版成功"),V()}catch(n){n!=="cancel"&&(console.error("删除模版失败:",n),z.error("删除模版失败"))}},E=()=>{V()},G=r=>{y.value={...r},D.value=!1,u.value=!0};return xe(()=>{V()}),(r,n)=>{const N=i("el-icon"),Y=i("el-button"),Q=i("el-input"),o=i("el-col"),s=i("el-option"),I=i("el-select"),L=i("el-row"),F=i("el-tag"),H=i("el-table-column"),B=i("el-dropdown-item"),ie=i("el-dropdown-menu"),re=i("el-dropdown"),de=i("el-button-group"),ne=i("el-table"),te=i("el-pagination"),me=i("el-card"),ce=he("loading");return x(),R("div",jt,[e(me,null,{header:t(()=>[a("div",At,[n[8]||(n[8]=a("div",{class:"header-left"},[a("h2",null,"消息模版管理"),a("p",{class:"page-description"},"管理告警消息的输出模版，支持多种格式和变量替换")],-1)),a("div",Nt,[e(Y,{type:"primary",onClick:S},{default:t(()=>[e(N,null,{default:t(()=>[e(q(be))]),_:1}),n[7]||(n[7]=p(" 添加模版 "))]),_:1,__:[7]})])])]),default:t(()=>[a("div",It,[e(L,{gutter:16},{default:t(()=>[e(o,{span:8},{default:t(()=>[e(Q,{modelValue:f.name,"onUpdate:modelValue":n[0]||(n[0]=c=>f.name=c),placeholder:"搜索模版名称...",clearable:"",onInput:l},{prefix:t(()=>[e(N,null,{default:t(()=>[e(q(ve))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(o,{span:6},{default:t(()=>[e(I,{modelValue:f.type,"onUpdate:modelValue":n[1]||(n[1]=c=>f.type=c),placeholder:"模版类型",clearable:"",onChange:l},{default:t(()=>[e(s,{label:"全部类型",value:""}),e(s,{label:"邮件模版",value:"email"}),e(s,{label:"钉钉模版",value:"dingtalk"}),e(s,{label:"企业微信",value:"wechat"}),e(s,{label:"Markdown",value:"markdown"})]),_:1},8,["modelValue"])]),_:1}),e(o,{span:6},{default:t(()=>[e(I,{modelValue:f.status,"onUpdate:modelValue":n[2]||(n[2]=c=>f.status=c),placeholder:"状态",clearable:"",onChange:l},{default:t(()=>[e(s,{label:"全部状态",value:""}),e(s,{label:"活跃",value:"active"}),e(s,{label:"停用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),e(o,{span:4},{default:t(()=>[e(Y,{onClick:v},{default:t(()=>n[9]||(n[9]=[p("重置")])),_:1,__:[9]})]),_:1})]),_:1})]),a("div",zt,[Ve((x(),U(ne,{data:g.value,stripe:"",style:{width:"100%"}},{default:t(()=>[e(H,{prop:"name",label:"模版名称","min-width":"150"},{default:t(c=>[a("div",Rt,[a("span",null,h(c.row.name),1),c.row.is_default?(x(),U(F,{key:0,type:"success",size:"small"},{default:t(()=>n[10]||(n[10]=[p("默认")])),_:1,__:[10]})):K("",!0)])]),_:1}),e(H,{prop:"type",label:"模版类型",width:"120"},{default:t(c=>[e(F,{type:T(c.row.type),size:"small"},{default:t(()=>[p(h(A(c.row.type)),1)]),_:2},1032,["type"])]),_:1}),e(H,{prop:"description",label:"描述","min-width":"200","show-overflow-tooltip":""}),e(H,{prop:"status",label:"状态",width:"80"},{default:t(c=>[e(F,{type:c.row.status==="active"?"success":"info",size:"small"},{default:t(()=>[p(h(c.row.status==="active"?"活跃":"停用"),1)]),_:2},1032,["type"])]),_:1}),e(H,{prop:"updated_at",label:"更新时间",width:"180"},{default:t(c=>[p(h(O(c.row.updated_at)),1)]),_:1}),e(H,{label:"操作",width:"250",fixed:"right"},{default:t(c=>[e(de,null,{default:t(()=>[e(Y,{type:"primary",size:"small",onClick:ae=>d(c.row),icon:q(Se)},{default:t(()=>n[11]||(n[11]=[p(" 预览 ")])),_:2,__:[11]},1032,["onClick","icon"]),e(Y,{type:"success",size:"small",onClick:ae=>m(c.row),icon:q(_e)},{default:t(()=>n[12]||(n[12]=[p(" 编辑 ")])),_:2,__:[12]},1032,["onClick","icon"]),e(re,{onCommand:ae=>$(ae,c.row)},{dropdown:t(()=>[e(ie,null,{default:t(()=>[e(B,{command:"setDefault",disabled:c.row.is_default},{default:t(()=>n[14]||(n[14]=[p(" 设为默认 ")])),_:2,__:[14]},1032,["disabled"]),e(B,{command:"duplicate"},{default:t(()=>n[15]||(n[15]=[p(" 复制模版 ")])),_:1,__:[15]}),e(B,{command:"toggleStatus",class:pe(c.row.status==="active"?"text-warning":"text-success")},{default:t(()=>[p(h(c.row.status==="active"?"停用":"启用"),1)]),_:2},1032,["class"]),e(B,{command:"delete",class:"text-danger",divided:""},{default:t(()=>n[16]||(n[16]=[p(" 删除 ")])),_:1,__:[16]})]),_:2},1024)]),default:t(()=>[e(Y,{size:"small",type:"info"},{default:t(()=>[n[13]||(n[13]=p(" 更多")),e(N,{class:"el-icon--right"},{default:t(()=>[e(q(ke))]),_:1})]),_:1,__:[13]})]),_:2},1032,["onCommand"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ce,j.value]]),a("div",Ut,[e(te,{"current-page":_.page,"onUpdate:currentPage":n[3]||(n[3]=c=>_.page=c),"page-size":_.size,"onUpdate:pageSize":n[4]||(n[4]=c=>_.size=c),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])])])]),_:1}),e(mt,{modelValue:u.value,"onUpdate:modelValue":n[5]||(n[5]=c=>u.value=c),"template-data":y.value,onSuccess:E},null,8,["modelValue","template-data"]),e(Mt,{modelValue:D.value,"onUpdate:modelValue":n[6]||(n[6]=c=>D.value=c),"template-data":y.value,onEdit:G},null,8,["modelValue","template-data"])])}}},Ht=ee(Pt,[["__scopeId","data-v-887d823e"]]);export{Ht as default};
//# sourceMappingURL=Templates-CR0bs0eI.js.map
