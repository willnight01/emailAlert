import{_ as me,r as z,a as I,n as fe,c as b,o as d,e as t,w as l,g as r,E as k,v as ge,d as x,B as ve,l as f,O as R,P as F,h as o,L as g,t as i,q as h,a8 as we,T as be,F as ye,C as Ce,U as q}from"./index-Cq749T7a.js";import{b as $}from"./index-DZNyvenB.js";import{f as D}from"./index-Cp9DYLzB.js";const ke={class:"alerts"},he={class:"search-filter"},xe={key:1,class:"text-gray-400"},Ve={class:"pagination-container"},ze={key:0,class:"alert-detail"},De={key:0,class:"sent-channels"},je={key:1,class:"text-gray-400"},Se={key:2,class:"error-msg"},Be={key:3,class:"text-gray-400"},Ue={class:"email-content"},Ye={class:"dialog-footer"},Me={__name:"Alerts",setup($e){const N=z([]),T=z(!1),v=I({subject:"",sender:"",status:""}),j=I({sort_by:"created_at",sort_order:"desc"}),y=z(""),u=I({page:1,size:20,total:0}),S=z(!1),s=z(null),c=async()=>{T.value=!0;try{const n={page:u.page,size:u.size,...v,...j};y.value&&y.value.length===2&&(n.start_date=D(y.value[0],"YYYY-MM-DD"),n.end_date=D(y.value[1],"YYYY-MM-DD")),Object.keys(n).forEach(_=>{(n[_]===""||n[_]===null||n[_]===void 0)&&delete n[_]});const e=await $.list(n);N.value=e.data.alerts||[],u.total=e.data.total||0}catch(n){console.error("获取告警列表失败:",n),k.error("获取告警列表失败")}finally{T.value=!1}},B=()=>{u.page=1,c()},Q=()=>{Object.assign(v,{subject:"",sender:"",status:""}),y.value="",Object.assign(j,{sort_by:"created_at",sort_order:"desc"}),u.page=1,c()},G=({column:n,prop:e,order:_})=>{e&&_&&(j.sort_by=e,j.sort_order=_==="ascending"?"asc":"desc",u.page=1,c())},H=n=>{u.size=n,u.page=1,c()},J=n=>{u.page=n,c()},K=n=>{s.value=n,S.value=!0},U=async n=>{try{await q.confirm(`确定要重试发送告警 "${n.subject}" 吗？`,"确认重试",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await $.retry(n.id),k.success("重试发送成功"),c()}catch(e){e!=="cancel"&&(console.error("重试告警失败:",e),k.error("重试发送失败"))}},W=async(n,e)=>{switch(n){case"sent":case"failed":await Z(e,n);break;case"retry":await U(e);break;case"delete":await X(e);break}},X=async n=>{try{await q.confirm(`确定要删除告警记录 "${n.subject}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await $.delete(n.id),k.success("删除成功"),c()}catch(e){e!=="cancel"&&k.error("删除失败")}},Z=async(n,e)=>{try{await $.updateStatus(n.id,{status:e}),k.success("状态更新成功"),c()}catch{k.error("状态更新失败")}},ee=()=>{s.value=null},L=n=>({pending:"warning",sent:"success",failed:"danger"})[n]||"info",P=n=>({pending:"待处理",sent:"已发送",failed:"发送失败"})[n]||n;return fe(()=>{c()}),(n,e)=>{const _=r("el-icon"),A=r("el-input"),V=r("el-col"),E=r("el-option"),te=r("el-select"),le=r("el-date-picker"),C=r("el-button"),ae=r("el-row"),p=r("el-table-column"),Y=r("el-tag"),M=r("el-dropdown-item"),ne=r("el-dropdown-menu"),oe=r("el-dropdown"),se=r("el-button-group"),re=r("el-table"),de=r("el-pagination"),ue=r("el-card"),w=r("el-descriptions-item"),ie=r("el-descriptions"),O=r("el-divider"),_e=r("el-alert"),ce=r("el-dialog"),pe=ge("loading");return d(),b("div",ke,[t(ue,null,{header:l(()=>e[11]||(e[11]=[x("div",{class:"page-header"},[x("span",null,"告警历史")],-1)])),default:l(()=>[x("div",he,[t(ae,{gutter:20},{default:l(()=>[t(V,{span:6},{default:l(()=>[t(A,{modelValue:v.subject,"onUpdate:modelValue":e[0]||(e[0]=a=>v.subject=a),placeholder:"搜索告警主题",onInput:B,clearable:""},{prefix:l(()=>[t(_,null,{default:l(()=>[t(f(R))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(V,{span:5},{default:l(()=>[t(A,{modelValue:v.sender,"onUpdate:modelValue":e[1]||(e[1]=a=>v.sender=a),placeholder:"搜索发件人",onInput:B,clearable:""},{prefix:l(()=>[t(_,null,{default:l(()=>[t(f(R))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(V,{span:4},{default:l(()=>[t(te,{modelValue:v.status,"onUpdate:modelValue":e[2]||(e[2]=a=>v.status=a),placeholder:"选择状态",onChange:B,clearable:""},{default:l(()=>[t(E,{label:"待处理",value:"pending"}),t(E,{label:"已发送",value:"sent"}),t(E,{label:"发送失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(V,{span:7},{default:l(()=>[t(le,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=a=>y.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:B,clearable:""},null,8,["modelValue"])]),_:1}),t(V,{span:2},{default:l(()=>[t(C,{onClick:Q,icon:f(F)},{default:l(()=>e[12]||(e[12]=[o("重置")])),_:1,__:[12]},8,["icon"])]),_:1})]),_:1})]),ve((d(),g(re,{data:N.value,style:{width:"100%"},onSortChange:G},{default:l(()=>[t(p,{prop:"subject",label:"告警主题","min-width":"200","show-overflow-tooltip":""}),t(p,{prop:"sender",label:"发件人",width:"180","show-overflow-tooltip":""}),t(p,{label:"邮箱源",width:"150"},{default:l(a=>{var m;return[o(i(((m=a.row.mailbox)==null?void 0:m.name)||"未知邮箱"),1)]}),_:1}),t(p,{label:"匹配规则",width:"150"},{default:l(a=>{var m;return[o(i(((m=a.row.rule_group)==null?void 0:m.name)||"无规则"),1)]}),_:1}),t(p,{prop:"status",label:"状态",width:"100",sortable:""},{default:l(a=>[t(Y,{type:L(a.row.status)},{default:l(()=>[o(i(P(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(p,{label:"发送渠道",width:"120"},{default:l(a=>[a.row.sent_channels?(d(),g(Y,{key:0,type:"success",size:"small"},{default:l(()=>[o(i(a.row.sent_channels.split(",").length)+"个渠道 ",1)]),_:2},1024)):(d(),b("span",xe,"未发送"))]),_:1}),t(p,{prop:"retry_count",label:"重试次数",width:"100"}),t(p,{prop:"received_at",label:"接收时间",width:"180",sortable:""},{default:l(a=>[o(i(f(D)(a.row.received_at)),1)]),_:1}),t(p,{label:"操作",width:"250",fixed:"right"},{default:l(a=>[t(se,null,{default:l(()=>[t(C,{type:"primary",size:"small",onClick:m=>K(a.row),icon:f(we)},{default:l(()=>e[13]||(e[13]=[o(" 查看详情 ")])),_:2,__:[13]},1032,["onClick","icon"]),a.row.status==="failed"||a.row.status==="pending"?(d(),g(C,{key:0,type:"warning",size:"small",onClick:m=>U(a.row),icon:f(F)},{default:l(()=>e[14]||(e[14]=[o(" 重试发送 ")])),_:2,__:[14]},1032,["onClick","icon"])):h("",!0),t(oe,{onCommand:m=>W(m,a.row)},{dropdown:l(()=>[t(ne,null,{default:l(()=>[a.row.status==="pending"?(d(),g(M,{key:0,command:"sent"},{default:l(()=>e[16]||(e[16]=[o(" 标记为已发送 ")])),_:1,__:[16]})):h("",!0),a.row.status==="pending"?(d(),g(M,{key:1,command:"failed"},{default:l(()=>e[17]||(e[17]=[o(" 标记为失败 ")])),_:1,__:[17]})):h("",!0),a.row.status==="sent"?(d(),g(M,{key:2,command:"retry"},{default:l(()=>e[18]||(e[18]=[o(" 重新发送 ")])),_:1,__:[18]})):h("",!0),t(M,{command:"delete",class:"text-danger",divided:""},{default:l(()=>e[19]||(e[19]=[o(" 删除记录 ")])),_:1,__:[19]})]),_:2},1024)]),default:l(()=>[t(C,{type:"info",size:"small"},{default:l(()=>[e[15]||(e[15]=o(" 更多")),t(_,{class:"el-icon--right"},{default:l(()=>[t(f(be))]),_:1})]),_:1,__:[15]})]),_:2},1032,["onCommand"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[pe,T.value]]),x("div",Ve,[t(de,{"current-page":u.page,"onUpdate:currentPage":e[4]||(e[4]=a=>u.page=a),"page-size":u.size,"onUpdate:pageSize":e[5]||(e[5]=a=>u.size=a),"page-sizes":[10,20,50,100],total:u.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:H,onCurrentChange:J},null,8,["current-page","page-size","total"])])]),_:1}),t(ce,{modelValue:S.value,"onUpdate:modelValue":e[10]||(e[10]=a=>S.value=a),title:"告警详情",width:"800px",onClose:ee},{footer:l(()=>[x("div",Ye,[t(C,{onClick:e[7]||(e[7]=a=>S.value=!1)},{default:l(()=>e[23]||(e[23]=[o("关闭")])),_:1,__:[23]}),s.value&&(s.value.status==="failed"||s.value.status==="pending")?(d(),g(C,{key:0,type:"warning",onClick:e[8]||(e[8]=a=>U(s.value))},{default:l(()=>e[24]||(e[24]=[o(" 重试发送 ")])),_:1,__:[24]})):h("",!0),s.value&&s.value.status==="sent"?(d(),g(C,{key:1,type:"primary",onClick:e[9]||(e[9]=a=>U(s.value))},{default:l(()=>e[25]||(e[25]=[o(" 重新发送 ")])),_:1,__:[25]})):h("",!0)])]),default:l(()=>[s.value?(d(),b("div",ze,[t(ie,{column:2,border:""},{default:l(()=>[t(w,{label:"告警主题"},{default:l(()=>[o(i(s.value.subject),1)]),_:1}),t(w,{label:"发件人"},{default:l(()=>[o(i(s.value.sender),1)]),_:1}),t(w,{label:"邮箱源"},{default:l(()=>{var a;return[o(i(((a=s.value.mailbox)==null?void 0:a.name)||"未知邮箱"),1)]}),_:1}),t(w,{label:"匹配规则"},{default:l(()=>{var a;return[o(i(((a=s.value.rule_group)==null?void 0:a.name)||"无规则"),1)]}),_:1}),t(w,{label:"状态"},{default:l(()=>[t(Y,{type:L(s.value.status)},{default:l(()=>[o(i(P(s.value.status)),1)]),_:1},8,["type"])]),_:1}),t(w,{label:"重试次数"},{default:l(()=>[o(i(s.value.retry_count||0),1)]),_:1}),t(w,{label:"接收时间"},{default:l(()=>[o(i(f(D)(s.value.received_at)),1)]),_:1}),t(w,{label:"创建时间"},{default:l(()=>[o(i(f(D)(s.value.created_at)),1)]),_:1})]),_:1}),t(O,null,{default:l(()=>e[20]||(e[20]=[o("发送渠道")])),_:1,__:[20]}),s.value.sent_channels?(d(),b("div",De,[(d(!0),b(ye,null,Ce(s.value.sent_channels.split(","),a=>(d(),g(Y,{key:a,type:"success",style:{"margin-right":"8px","margin-bottom":"8px"}},{default:l(()=>[o(i(a),1)]),_:2},1024))),128))])):(d(),b("div",je,"未发送到任何渠道")),t(O,null,{default:l(()=>e[21]||(e[21]=[o("错误信息")])),_:1,__:[21]}),s.value.error_msg?(d(),b("div",Se,[t(_e,{title:s.value.error_msg,type:"error",closable:!1,"show-icon":""},null,8,["title"])])):(d(),b("div",Be,"无错误信息")),t(O,null,{default:l(()=>e[22]||(e[22]=[o("邮件内容")])),_:1,__:[22]}),x("div",Ue,[t(A,{modelValue:s.value.content,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.content=a),type:"textarea",rows:8,readonly:"",placeholder:"邮件内容"},null,8,["modelValue"])])])):h("",!0)]),_:1},8,["modelValue"])])}}},Oe=me(Me,[["__scopeId","data-v-09de54fa"]]);export{Oe as default};
//# sourceMappingURL=Alerts-64oe0-QE.js.map
