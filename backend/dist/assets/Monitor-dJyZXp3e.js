import{_ as re,r as p,n as ie,p as ue,V as de,E as b,W as ce,c as M,o as m,e as s,w as t,g as _,v as _e,d as o,s as W,L as X,X as fe,t as v,l as g,x as pe,Y as ve,Z as Y,h as c,M as ge,$ as me,a0 as he,P as Z,B as we,q as ye,F as be,C as Ce,a1 as Me,a2 as ke,a3 as xe,a4 as Se,a5 as Te}from"./index-Cq749T7a.js";import{c as h,m as Ve}from"./index-DZNyvenB.js";const Le={class:"monitor"},ze={class:"panel-header"},De={class:"panel-title-section"},Ee={class:"control-actions"},Ie={class:"status-item"},Be={class:"status-icon"},Ne={class:"status-content"},Pe={class:"status-value"},Ae={class:"status-item"},Fe={class:"status-icon"},Re={class:"status-content"},Ue={class:"status-value"},qe={class:"status-item"},We={class:"status-icon"},Xe={class:"status-content"},Ye={class:"status-value"},Ze={class:"status-item"},$e={class:"status-icon"},je={class:"status-content"},Ge={class:"status-value"},He={class:"card-header"},Je={key:0,class:"error-text"},Ke={key:1,class:"success-text"},Oe={class:"card-header"},Qe={class:"log-time"},es={class:"log-message"},ss={key:0,class:"no-logs"},ts={class:"card-header"},as={class:"chart-container"},os={class:"chart-placeholder"},ls={__name:"Monitor",setup(ns){const i=p("stopped"),V=p(!1),L=p(!1),z=p(!1),D=p(!1),k=p({activeMailboxes:0,todayEmails:0,errorCount:0}),E=p([]),w=p([]),I=p(),F=p("24h");let x=null,C=null;ie(async()=>{await B(),u("info","页面加载时自动刷新配置...");try{i.value==="running"?(await h.refresh(),u("success","监控配置已自动刷新")):u("info","监控未运行，直接刷新邮箱状态")}catch(a){console.warn("自动刷新配置失败:",a),u("warning","自动刷新配置失败，请手动刷新")}await S(),K()}),ue(()=>{O()}),de(async()=>{if(u("info","页面激活，检查配置更新..."),await B(),i.value==="running")try{await h.refresh(),u("success","配置已更新到最新状态")}catch(a){console.warn("激活时刷新配置失败:",a)}await S()});const B=async()=>{try{const e=(await h.status()).data.is_running;i.value=e?"running":"stopped",i.value==="running"&&N()}catch(a){console.error("加载监控状态失败:",a),i.value="error"}},N=async()=>{try{const a=await h.stats();k.value=a.data||{}}catch(a){console.error("加载监控统计失败:",a)}},S=async()=>{D.value=!0;try{const e=(await Ve.list({status:"active"})).data.list||[];E.value=e.map(n=>({...n,status:i.value==="running"?"monitoring":"stopped",lastCheck:i.value==="running"?new Date:null,emailCount:0,connected:n.status==="active",errorMessage:n.status!=="active"?"邮箱未激活":null})),console.log("加载邮箱监控状态:",E.value)}catch(a){console.error("加载邮箱状态失败:",a),b.error("加载邮箱状态失败")}finally{D.value=!1}},$=async()=>{var a,e,n,f;V.value=!0;try{await h.start(),i.value="running",b.success("邮件监控已启动"),u("info","邮件监控服务已启动"),N()}catch(l){let r="未知错误";(e=(a=l.response)==null?void 0:a.data)!=null&&e.message?r=l.response.data.message:(f=(n=l.response)==null?void 0:n.data)!=null&&f.error?r=l.response.data.error:l.message&&(r=l.message),console.error("启动监控错误详情:",l),b.error("启动监控失败: "+r),u("error","启动监控失败: "+r)}finally{V.value=!1}},j=async()=>{var a,e,n,f;L.value=!0;try{await h.stop(),i.value="stopped",b.success("邮件监控已停止"),u("warning","邮件监控服务已停止")}catch(l){let r="未知错误";(e=(a=l.response)==null?void 0:a.data)!=null&&e.message?r=l.response.data.message:(f=(n=l.response)==null?void 0:n.data)!=null&&f.error?r=l.response.data.error:l.message&&(r=l.message),console.error("停止监控错误详情:",l),b.error("停止监控失败: "+r),u("error","停止监控失败: "+r)}finally{L.value=!1}},G=async()=>{var a,e,n,f;z.value=!0;try{i.value==="running"?(await h.refresh(),u("success","监控服务配置已刷新")):u("info","监控未运行，跳过服务配置刷新"),await S(),b.success("配置已刷新"),u("success","页面配置刷新完成")}catch(l){let r="未知错误";(e=(a=l.response)==null?void 0:a.data)!=null&&e.message?r=l.response.data.message:(f=(n=l.response)==null?void 0:n.data)!=null&&f.error?r=l.response.data.error:l.message&&(r=l.message),console.error("刷新配置错误详情:",l),b.error("刷新配置失败: "+r),u("error","刷新配置失败: "+r)}finally{z.value=!1}},H=()=>{S()},u=(a,e,n=null)=>{w.value.unshift({timestamp:n?new Date(n):new Date,level:a,message:e}),w.value.length>100&&(w.value=w.value.slice(0,100)),ce(()=>{I.value&&(I.value.scrollTop=0)})},J=()=>{w.value=[]},K=()=>{x=setInterval(()=>{B(),i.value==="running"&&N()},3e4),R()},R=()=>{C&&C.close();try{C=h.createLogStream(a=>{u(a.level,a.message,a.timestamp)},a=>{console.error("日志流连接错误:",a),u("error","日志连接中断，尝试重新连接..."),setTimeout(()=>{i.value==="running"&&R()},3e3)})}catch(a){console.error("创建日志流失败:",a),u("error","无法建立日志连接")}},O=()=>{x&&(clearInterval(x),x=null),C&&(C.close(),C=null)},Q=()=>{switch(i.value){case"running":return"running";case"stopped":return"stopped";case"error":return"error";default:return"unknown"}},ee=()=>{switch(i.value){case"running":return"#67c23a";case"stopped":return"#909399";case"error":return"#f56c6c";default:return"#909399"}},se=()=>{switch(i.value){case"running":return Te;case"stopped":return Se;case"error":return Y;default:return xe}},te=()=>{switch(i.value){case"running":return"运行中";case"stopped":return"已停止";case"error":return"错误";default:return"未知"}},U=a=>a?new Date(a).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";return(a,e)=>{const n=_("el-icon"),f=_("el-text"),l=_("el-button"),r=_("el-col"),P=_("el-row"),T=_("el-card"),y=_("el-table-column"),q=_("el-tag"),ae=_("el-table"),A=_("el-radio-button"),oe=_("el-radio-group"),le=_e("loading");return m(),M("div",Le,[s(T,{class:"control-panel"},{header:t(()=>[o("div",ze,[o("div",De,[e[2]||(e[2]=o("span",null,"邮件监控控制面板",-1)),s(f,{size:"small",type:"info",class:"auto-refresh-tip"},{default:t(()=>[s(n,null,{default:t(()=>[s(g(ge))]),_:1}),e[1]||(e[1]=c(" 页面会自动刷新最新配置 "))]),_:1,__:[1]})]),o("div",Ee,[s(l,{type:"success",onClick:$,loading:V.value,disabled:i.value==="running"},{default:t(()=>[s(n,null,{default:t(()=>[s(g(me))]),_:1}),e[3]||(e[3]=c(" 启动监控 "))]),_:1,__:[3]},8,["loading","disabled"]),s(l,{type:"danger",onClick:j,loading:L.value,disabled:i.value!=="running"},{default:t(()=>[s(n,null,{default:t(()=>[s(g(he))]),_:1}),e[4]||(e[4]=c(" 停止监控 "))]),_:1,__:[4]},8,["loading","disabled"]),s(l,{type:"primary",onClick:G,loading:z.value,title:"重新加载邮箱配置并更新监控服务"},{default:t(()=>[s(n,null,{default:t(()=>[s(g(Z))]),_:1}),e[5]||(e[5]=c(" 刷新配置 "))]),_:1,__:[5]},8,["loading"])])])]),default:t(()=>[s(P,{gutter:20},{default:t(()=>[s(r,{span:6},{default:t(()=>[o("div",Ie,[o("div",Be,[s(n,{class:W(["status-indicator",Q()]),color:ee()},{default:t(()=>[(m(),X(fe(se())))]),_:1},8,["class","color"])]),o("div",Ne,[e[6]||(e[6]=o("div",{class:"status-title"},"监控状态",-1)),o("div",Pe,v(te()),1)])])]),_:1}),s(r,{span:6},{default:t(()=>[o("div",Ae,[o("div",Fe,[s(n,{color:"#409eff"},{default:t(()=>[s(g(pe))]),_:1})]),o("div",Re,[e[7]||(e[7]=o("div",{class:"status-title"},"监控邮箱",-1)),o("div",Ue,v(k.value.activeMailboxes||0),1)])])]),_:1}),s(r,{span:6},{default:t(()=>[o("div",qe,[o("div",We,[s(n,{color:"#67c23a"},{default:t(()=>[s(g(ve))]),_:1})]),o("div",Xe,[e[8]||(e[8]=o("div",{class:"status-title"},"今日邮件",-1)),o("div",Ye,v(k.value.todayEmails||0),1)])])]),_:1}),s(r,{span:6},{default:t(()=>[o("div",Ze,[o("div",$e,[s(n,{color:"#f56c6c"},{default:t(()=>[s(g(Y))]),_:1})]),o("div",je,[e[9]||(e[9]=o("div",{class:"status-title"},"错误次数",-1)),o("div",Ge,v(k.value.errorCount||0),1)])])]),_:1})]),_:1})]),_:1}),s(P,{gutter:20,class:"mt-20"},{default:t(()=>[s(r,{span:16},{default:t(()=>[s(T,null,{header:t(()=>[o("div",He,[e[11]||(e[11]=o("span",null,"邮箱监控详情",-1)),s(l,{type:"text",onClick:H},{default:t(()=>[s(n,null,{default:t(()=>[s(g(Z))]),_:1}),e[10]||(e[10]=c(" 刷新 "))]),_:1,__:[10]})])]),default:t(()=>[we((m(),X(ae,{data:E.value,style:{width:"100%"}},{default:t(()=>[s(y,{prop:"name",label:"邮箱名称",width:"150"}),s(y,{prop:"email",label:"邮箱地址",width:"200"}),s(y,{label:"监控状态",width:"120"},{default:t(d=>[s(q,{type:d.row.status==="monitoring"?"success":"danger",size:"small"},{default:t(()=>[c(v(d.row.status==="monitoring"?"监控中":"已停止"),1)]),_:2},1032,["type"])]),_:1}),s(y,{prop:"lastCheck",label:"最后检查",width:"160"},{default:t(d=>[c(v(U(d.row.lastCheck)),1)]),_:1}),s(y,{prop:"emailCount",label:"邮件数量",width:"100"}),s(y,{label:"连接状态",width:"120"},{default:t(d=>[s(q,{type:d.row.connected?"success":"danger",size:"small"},{default:t(()=>[c(v(d.row.connected?"已连接":"连接失败"),1)]),_:2},1032,["type"])]),_:1}),s(y,{prop:"errorMessage",label:"错误信息","min-width":"200"},{default:t(d=>[d.row.errorMessage?(m(),M("span",Je,v(d.row.errorMessage),1)):(m(),M("span",Ke,"正常"))]),_:1})]),_:1},8,["data"])),[[le,D.value]])]),_:1})]),_:1}),s(r,{span:8},{default:t(()=>[s(T,null,{header:t(()=>[o("div",Oe,[e[13]||(e[13]=o("span",null,"实时日志",-1)),s(l,{type:"text",onClick:J},{default:t(()=>[s(n,null,{default:t(()=>[s(g(Me))]),_:1}),e[12]||(e[12]=c(" 清空 "))]),_:1,__:[12]})])]),default:t(()=>[o("div",{class:"log-container",ref_key:"logContainer",ref:I},[(m(!0),M(be,null,Ce(w.value,(d,ne)=>(m(),M("div",{key:ne,class:W(["log-item",d.level])},[o("span",Qe,v(U(d.timestamp)),1),o("span",es,v(d.message),1)],2))),128)),w.value.length===0?(m(),M("div",ss," 暂无日志信息 ")):ye("",!0)],512)]),_:1})]),_:1})]),_:1}),s(P,{class:"mt-20"},{default:t(()=>[s(r,{span:24},{default:t(()=>[s(T,null,{header:t(()=>[o("div",ts,[e[17]||(e[17]=o("span",null,"邮件处理统计",-1)),s(oe,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=d=>F.value=d),size:"small"},{default:t(()=>[s(A,{label:"1h"},{default:t(()=>e[14]||(e[14]=[c("最近1小时")])),_:1,__:[14]}),s(A,{label:"24h"},{default:t(()=>e[15]||(e[15]=[c("最近24小时")])),_:1,__:[15]}),s(A,{label:"7d"},{default:t(()=>e[16]||(e[16]=[c("最近7天")])),_:1,__:[16]})]),_:1},8,["modelValue"])])]),default:t(()=>[o("div",as,[o("div",os,[s(n,null,{default:t(()=>[s(g(ke))]),_:1}),e[18]||(e[18]=o("span",null,"邮件处理统计图表（待集成图表库）",-1))])])]),_:1})]),_:1})]),_:1})])}}},us=re(ls,[["__scopeId","data-v-be9f3f1d"]]);export{us as default};
//# sourceMappingURL=Monitor-dJyZXp3e.js.map
