import{_ as ye,r as x,a as G,n as be,c,o as d,e as t,w as l,g as r,E as k,v as he,d as p,B as ke,F as Ce,C as Ve,L as D,l as f,O as xe,P as H,h as s,t as i,q as T,a8 as ze,T as De,U as J}from"./index-Cq749T7a.js";import{d as Ue,n as N}from"./index-DZNyvenB.js";import{f as C}from"./index-Cp9DYLzB.js";const Le={class:"notification-logs"},Be={class:"search-filter"},Se={style:{"font-weight":"500"}},Te={key:0},Ye={class:"alert-subject"},je={class:"alert-sender"},Me={key:1,class:"text-gray-400"},Re={class:"content-preview"},Ne={key:0},Oe={key:1,class:"text-gray-400"},$e={class:"pagination-container"},Ee={key:0,class:"log-detail"},Pe={key:0,class:"alert-info"},Ie={key:1,class:"text-gray-400"},Ae={class:"send-content"},Fe={key:2,class:"error-info"},qe={key:3,class:"text-gray-400"},Qe={key:4,class:"response-data"},We={key:5,class:"text-gray-400"},Ge={class:"dialog-footer"},He={__name:"NotificationLogs",setup(Je){const O=x([]),Y=x(!1),$=x([]),v=G({channel_id:"",status:"",content:""}),b=x(""),u=G({page:1,size:20,total:0}),U=x(!1),n=x(null),h=async()=>{Y.value=!0;try{const o={page:u.page,size:u.size,...v};b.value&&b.value.length===2&&(o.start_date=C(b.value[0],"YYYY-MM-DD"),o.end_date=C(b.value[1],"YYYY-MM-DD"));const e=await N.list(o);O.value=e.data.logs||[],u.total=e.data.total||0}catch(o){console.error("获取通知历史失败:",o),k.error("获取通知历史失败")}finally{Y.value=!1}},K=async()=>{try{const o=await Ue.list({size:100});$.value=o.data.channels||[]}catch(o){console.error("获取渠道选项失败:",o)}},L=()=>{u.page=1,h()},X=()=>{Object.assign(v,{channel_id:"",status:"",content:""}),b.value="",u.page=1,h()},Z=({column:o,prop:e,order:w})=>{console.log("排序变化:",{column:o,prop:e,order:w})},ee=o=>{u.size=o,u.page=1,h()},te=o=>{u.page=o,h()},le=o=>{n.value=o,U.value=!0},ae=async(o,e)=>{switch(o){case"retry":await j(e);break;case"download":await oe(e);break;case"delete":await ne(e);break}},oe=async o=>{try{const e=o.content||"无内容",w=new Blob([e],{type:"text/plain;charset=utf-8"}),z=window.URL.createObjectURL(w),_=document.createElement("a");_.href=z,_.download=`notification_${o.id}_${new Date().getTime()}.txt`,document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(z),k.success("下载成功")}catch(e){console.error("下载失败:",e),k.error("下载失败")}},ne=async o=>{try{await J.confirm("确定要删除这条通知记录吗？此操作不可恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await N.delete(o.id),k.success("删除成功"),h()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),k.error("删除失败"))}},j=async o=>{try{await J.confirm("确定要重试发送通知吗？","确认重试",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await N.retry(o.id),k.success("通知已加入重试队列"),h()}catch(e){e!=="cancel"&&(console.error("重试发送失败:",e),k.error("重试发送失败"))}},se=()=>{n.value=null},E=o=>({pending:"warning",success:"success",failed:"danger"})[o]||"info",P=o=>({pending:"待发送",success:"发送成功",failed:"发送失败"})[o]||o,I=o=>({wechat:"企业微信",dingtalk:"钉钉",email:"邮件",webhook:"Webhook"})[o]||o,A=o=>({wechat:"success",dingtalk:"primary",email:"warning",webhook:"info"})[o]||"info",re=o=>o?o.length>100?o.substring(0,100)+"...":o:"无内容";return be(()=>{K(),h()}),(o,e)=>{const w=r("el-option"),z=r("el-select"),_=r("el-col"),de=r("el-date-picker"),F=r("el-icon"),M=r("el-input"),V=r("el-button"),ie=r("el-row"),B=r("el-tag"),y=r("el-table-column"),R=r("el-dropdown-item"),ue=r("el-dropdown-menu"),ce=r("el-dropdown"),_e=r("el-button-group"),pe=r("el-table"),fe=r("el-pagination"),me=r("el-card"),m=r("el-descriptions-item"),q=r("el-descriptions"),S=r("el-divider"),ge=r("el-alert"),ve=r("el-dialog"),we=he("loading");return d(),c("div",Le,[t(me,null,{header:l(()=>e[11]||(e[11]=[p("div",{class:"page-header"},[p("span",null,"通知发送历史")],-1)])),default:l(()=>[p("div",Be,[t(ie,{gutter:20},{default:l(()=>[t(_,{span:5},{default:l(()=>[t(z,{modelValue:v.channel_id,"onUpdate:modelValue":e[0]||(e[0]=a=>v.channel_id=a),placeholder:"选择渠道",onChange:L,clearable:""},{default:l(()=>[(d(!0),c(Ce,null,Ve($.value,a=>(d(),D(w,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(_,{span:5},{default:l(()=>[t(z,{modelValue:v.status,"onUpdate:modelValue":e[1]||(e[1]=a=>v.status=a),placeholder:"选择状态",onChange:L,clearable:""},{default:l(()=>[t(w,{label:"待发送",value:"pending"}),t(w,{label:"发送成功",value:"success"}),t(w,{label:"发送失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(_,{span:6},{default:l(()=>[t(de,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=a=>b.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:L,clearable:""},null,8,["modelValue"])]),_:1}),t(_,{span:6},{default:l(()=>[t(M,{modelValue:v.content,"onUpdate:modelValue":e[3]||(e[3]=a=>v.content=a),placeholder:"搜索发送内容",onInput:L,clearable:""},{prefix:l(()=>[t(F,null,{default:l(()=>[t(f(xe))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(_,{span:2},{default:l(()=>[t(V,{onClick:X,icon:f(H)},{default:l(()=>e[12]||(e[12]=[s("重置")])),_:1,__:[12]},8,["icon"])]),_:1})]),_:1})]),ke((d(),D(pe,{data:O.value,style:{width:"100%"},onSortChange:Z},{default:l(()=>[t(y,{label:"渠道信息",width:"180"},{default:l(a=>{var g,Q;return[p("div",null,[p("div",Se,i(((g=a.row.channel)==null?void 0:g.name)||"未知渠道"),1),t(B,{type:A((Q=a.row.channel)==null?void 0:Q.type),size:"small"},{default:l(()=>{var W;return[s(i(I((W=a.row.channel)==null?void 0:W.type)),1)]}),_:2},1032,["type"])])]}),_:1}),t(y,{label:"告警信息","min-width":"200"},{default:l(a=>[a.row.alert?(d(),c("div",Te,[p("div",Ye,i(a.row.alert.subject),1),p("div",je,"发件人: "+i(a.row.alert.sender),1)])):(d(),c("span",Me,"无关联告警"))]),_:1}),t(y,{prop:"content",label:"发送内容","min-width":"300","show-overflow-tooltip":""},{default:l(a=>[p("div",Re,i(re(a.row.content)),1)]),_:1}),t(y,{prop:"status",label:"发送状态",width:"120",sortable:""},{default:l(a=>[t(B,{type:E(a.row.status)},{default:l(()=>[s(i(P(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(y,{prop:"retry_count",label:"重试次数",width:"100",align:"center"}),t(y,{prop:"sent_at",label:"发送时间",width:"180",sortable:""},{default:l(a=>[a.row.sent_at?(d(),c("div",Ne,i(f(C)(a.row.sent_at)),1)):(d(),c("span",Oe,"未发送"))]),_:1}),t(y,{prop:"created_at",label:"创建时间",width:"180",sortable:""},{default:l(a=>[s(i(f(C)(a.row.created_at)),1)]),_:1}),t(y,{label:"操作",width:"250",fixed:"right"},{default:l(a=>[t(_e,null,{default:l(()=>[t(V,{type:"primary",size:"small",onClick:g=>le(a.row),icon:f(ze)},{default:l(()=>e[13]||(e[13]=[s(" 查看详情 ")])),_:2,__:[13]},1032,["onClick","icon"]),a.row.status==="failed"?(d(),D(V,{key:0,type:"warning",size:"small",onClick:g=>j(a.row),icon:f(H)},{default:l(()=>e[14]||(e[14]=[s(" 重试 ")])),_:2,__:[14]},1032,["onClick","icon"])):T("",!0),t(ce,{onCommand:g=>ae(g,a.row)},{dropdown:l(()=>[t(ue,null,{default:l(()=>[a.row.status!=="failed"?(d(),D(R,{key:0,command:"retry"},{default:l(()=>e[16]||(e[16]=[s(" 重试发送 ")])),_:1,__:[16]})):T("",!0),t(R,{command:"download"},{default:l(()=>e[17]||(e[17]=[s(" 下载内容 ")])),_:1,__:[17]}),t(R,{command:"delete",class:"text-danger",divided:""},{default:l(()=>e[18]||(e[18]=[s(" 删除记录 ")])),_:1,__:[18]})]),_:2},1024)]),default:l(()=>[t(V,{size:"small",type:"info"},{default:l(()=>[e[15]||(e[15]=s(" 更多")),t(F,{class:"el-icon--right"},{default:l(()=>[t(f(De))]),_:1})]),_:1,__:[15]})]),_:2},1032,["onCommand"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[we,Y.value]]),p("div",$e,[t(fe,{"current-page":u.page,"onUpdate:currentPage":e[4]||(e[4]=a=>u.page=a),"page-size":u.size,"onUpdate:pageSize":e[5]||(e[5]=a=>u.size=a),"page-sizes":[10,20,50,100],total:u.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ee,onCurrentChange:te},null,8,["current-page","page-size","total"])])]),_:1}),t(ve,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=a=>U.value=a),title:"通知发送详情",width:"800px",onClose:se},{footer:l(()=>[p("div",Ge,[t(V,{onClick:e[8]||(e[8]=a=>U.value=!1)},{default:l(()=>e[23]||(e[23]=[s("关闭")])),_:1,__:[23]}),n.value&&n.value.status==="failed"?(d(),D(V,{key:0,type:"warning",onClick:e[9]||(e[9]=a=>j(n.value))},{default:l(()=>e[24]||(e[24]=[s(" 重试发送 ")])),_:1,__:[24]})):T("",!0)])]),default:l(()=>[n.value?(d(),c("div",Ee,[t(q,{column:2,border:""},{default:l(()=>[t(m,{label:"渠道名称"},{default:l(()=>{var a;return[s(i(((a=n.value.channel)==null?void 0:a.name)||"未知渠道"),1)]}),_:1}),t(m,{label:"渠道类型"},{default:l(()=>{var a;return[t(B,{type:A((a=n.value.channel)==null?void 0:a.type)},{default:l(()=>{var g;return[s(i(I((g=n.value.channel)==null?void 0:g.type)),1)]}),_:1},8,["type"])]}),_:1}),t(m,{label:"发送状态"},{default:l(()=>[t(B,{type:E(n.value.status)},{default:l(()=>[s(i(P(n.value.status)),1)]),_:1},8,["type"])]),_:1}),t(m,{label:"重试次数"},{default:l(()=>[s(i(n.value.retry_count||0),1)]),_:1}),t(m,{label:"创建时间"},{default:l(()=>[s(i(f(C)(n.value.created_at)),1)]),_:1}),t(m,{label:"发送时间"},{default:l(()=>[s(i(n.value.sent_at?f(C)(n.value.sent_at):"未发送"),1)]),_:1})]),_:1}),t(S,null,{default:l(()=>e[19]||(e[19]=[s("关联告警")])),_:1,__:[19]}),n.value.alert?(d(),c("div",Pe,[t(q,{column:1,border:""},{default:l(()=>[t(m,{label:"告警主题"},{default:l(()=>[s(i(n.value.alert.subject),1)]),_:1}),t(m,{label:"发件人"},{default:l(()=>[s(i(n.value.alert.sender),1)]),_:1}),t(m,{label:"接收时间"},{default:l(()=>[s(i(f(C)(n.value.alert.received_at)),1)]),_:1})]),_:1})])):(d(),c("div",Ie,"无关联告警信息")),t(S,null,{default:l(()=>e[20]||(e[20]=[s("发送内容")])),_:1,__:[20]}),p("div",Ae,[t(M,{modelValue:n.value.content,"onUpdate:modelValue":e[6]||(e[6]=a=>n.value.content=a),type:"textarea",rows:8,readonly:"",placeholder:"发送内容"},null,8,["modelValue"])]),t(S,null,{default:l(()=>e[21]||(e[21]=[s("错误信息")])),_:1,__:[21]}),n.value.error_msg?(d(),c("div",Fe,[t(ge,{title:n.value.error_msg,type:"error",closable:!1,"show-icon":""},null,8,["title"])])):(d(),c("div",qe,"无错误信息")),t(S,null,{default:l(()=>e[22]||(e[22]=[s("响应数据")])),_:1,__:[22]}),n.value.response_data?(d(),c("div",Qe,[t(M,{modelValue:n.value.response_data,"onUpdate:modelValue":e[7]||(e[7]=a=>n.value.response_data=a),type:"textarea",rows:4,readonly:"",placeholder:"响应数据"},null,8,["modelValue"])])):(d(),c("div",We,"无响应数据"))])):T("",!0)]),_:1},8,["modelValue"])])}}},et=ye(He,[["__scopeId","data-v-8baf45d1"]]);export{et as default};
//# sourceMappingURL=NotificationLogs-Cvpe-7Zf.js.map
